<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <title>Image Browser</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.77/dist/themes/light.css" />
  <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.77/dist/shoelace.js"></script>
  <link rel = "stylesheet" href = "style.css">
  <style>
    [v-cloak] {display: none}
    * {box-sizing: border-box;}
    body {margin: 0; font-family: Roboto, sans-serif;}
    .name {margin-right:12px; cursor:pointer;}    
    .name:hover {font-weight:bold;}    
  </style>
</head>
<body>
  <div id = "app" v-cloak>

    <div id = "dirs">
      <div class = "dir" id = "rootButton">
        <sl-button v-on:click = "openDir(root)" v-if = "this.path != this.root">
          <sl-icon name = "house"></sl-icon>
        </sl-button>
      </div>
      <div class = "dir" v-for = "dir in dirs">
        <sl-button v-on:click = "openDir(path + dir.name)" v-html = "`<sl-icon name = 'folder'></sl-icon> ` + dir.name"></sl-button>
      </div>
    </div>

    <h3 v-html = "displayPath()"></h3>
    <hr>

    <div v-if = "Object.keys(iiifs).length > 0">
      <p><i>Click image for the IIIF manifest to be added to your clipboard</i></p>
      <div id = "iiifs">
        <div class = "iiif" v-for = "iiif in iiifs">
          <sl-tooltip v-bind:content = "getImageTooltip(iiif.image)" >
            <img v-if="(iiif.image || iiif.yaml) && manifests[iiif.image?.name || iiif.yaml?.name]" :src="manifests[iiif.image?.name || iiif.yaml?.name].thumbnail[0].id" v-on:click = "copyManifest(iiif)"  v-if = "iiif.image != undefined"/> 
            <sl-icon name = "question" v-else></sl-icon>
          </sl-tooltip>
        </div>
      </div>
    </div>

    <div v-if = "otherFiles.length > 0">
      <hr/>
      <h2>Other files:</h2>
      <div id = "otherFiles">
        <div class = "otherFile" v-for = "file in otherFiles" v-html = "file.name"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>
  
  <!-- This is used for deep linking of Single Page Apps when hosted with GitHub Pages -->
  <script type="text/javascript">
    (function(l) {
      if (l.search[1] === '/' ) {
        let decoded = l.search.slice(1).split('&').map(s => s.replace(/~and~/g, '&')).join('?')
        window.history.replaceState(null, null, l.pathname.slice(0, -1) + decoded + l.hash)
      }
    }(window.location))
  </script>

  <script>
  
  const api = 'https://api.juncture-digital.org'
  const iiifServer = 'https://iiif.juncture-digital.org'

  new Vue({
    el: '#app',
    data: () => ({
      componentKey: 0,
      ghAcct: 'kent-map',
      ghRepo: 'images',
      root: '/',
      path: '/',
      dirList: [],
      iiifs: {},
      otherFiles: [],
      dirs: [],
      manifests: {}
    }),
    computed: {},
    created() {},
    async mounted() {
      this.getFilesAndDirs()
    },
    methods: {
      getManifest(item) {
        let manifestUrl = `${iiifServer}/gh:${this.ghAcct}/${this.ghRepo}${this.path}${encodeURIComponent(item.name)}/manifest.json`
        fetch(manifestUrl).then(resp => resp.json())
        .then(manifest => {
          let updated = {...this.manifests}
          updated[item.name] = manifest
          this.manifests = updated
        })
      },

      // Gets all files and directories in current directory
      async getFilesAndDirs() {

        this.dirList = await fetch(`${api}/dir/${this.ghAcct}/${this.ghRepo}${this.path}`).then(resp => resp.json());

        // Clear previous files and directories
        this.iiifs = {};
        this.otherFiles = [];
        this.dirs = [];

        for (var i = 0; i < this.dirList.length; i++) {
          var item = this.dirList[i]
          var type = item.type;
        
          if (type == "dir") {
            this.dirs.push(item);
          }

          // For files
          else {

            // Split file into name and extension
            var split = this.splitFileNameAndExtension(this.dirList[i].name);
            var fileName = split[0];
            var fileExtension = split[1];

            // If file is a YAML file add it to IIIF dictionary
            if (fileExtension == "yaml") {
              this.iiifs[fileName] = this.createDictionaryIfUndefined(this.iiifs[fileName]);
              this.iiifs[fileName].yaml = item;
              this.getManifest(item)
            }

             // If file is an image file add it to IIIF dictionary
            else if ((fileExtension == "png") || (fileExtension == "jpg") || (fileExtension == "jpeg")) {
              this.iiifs[fileName] = this.createDictionaryIfUndefined(this.iiifs[fileName]);
              this.iiifs[fileName].image = item;
              this.getManifest(item)
            }

            // If file is not a YAML or image file, add it to a list of other files
            else {
              this.otherFiles.push(item);
            }
          }
        }

      },

      // Splits file into file name and file extension
      splitFileNameAndExtension(file) {
        var split = file.split(".");

        // If no extension
        if (split.length == 1) {
          fileName = file;
          fileExtension = "";
        }

        else {
          fileName = split.slice(0, -1).join(".");
          fileExtension = split.pop();
        }
        
        return [fileName, fileExtension.toLowerCase()]
      },

      // Creates a new dictionary if one does not already exist, used when adding a YAML or image
      // entry to IIIF[fileName]
      createDictionaryIfUndefined(value) {
        if (value == undefined) {
          value = {}
        }
        return value
      },

      // Sets path to given directory and re-get files and dirs
      openDir(dirName) {

        // Make dirName start & end with one /
        if (dirName != "/") {
          if (dirName.slice(0, 1) != "/") {
            dirName = `/${dirName}`;
          }
          if (dirName.slice(dirName.length - 2, dirName.length - 1) != "/") {
            dirName = `${dirName}/`;
          }
        }

        this.path = dirName;
        this.getFilesAndDirs();
      },

      // Get the current directory path to display on screen
      displayPath() {
        var displayPath = this.path.slice(1, this.path.length - 1);

        if (this.path == this.root) {
          displayPath = "root";
        }

        return displayPath + ":";
      },

      // A more user-readable image path
      getImageTooltip(image) {
        if (image == undefined) {
          return "?";
        }
        else {
          return (image.name);
        }

      },

      // Copies manifest to clipboard
      copyManifest(iiif) {

        var image = iiif.image;
        var yaml = iiif.yaml;

        // If only YAML file given
        if ((image == undefined) && (yaml != undefined)) {
          var manifest = `https://iiif.visual-essays.net/gh:${this.ghAcct}/${this.ghRepo}/${yaml.name}/manifest.json`
          navigator.clipboard.writeText(manifest);
        }

        // If image given
        else {
          var manifest = `https://iiif.visual-essays.net/gh:${this.ghAcct}/${this.ghRepo}/${image.name}/manifest.json`
          navigator.clipboard.writeText(manifest);
        }
      }

    },
    watch: {}
  })
  Vue.config.productionTip = false
  Vue.config.devtools = true

  </script>
</body>
</html>
